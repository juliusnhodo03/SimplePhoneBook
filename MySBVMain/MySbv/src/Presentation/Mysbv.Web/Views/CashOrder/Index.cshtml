@using Application.Dto.CashOrder
@using Kendo.Mvc.UI
@model IEnumerable<Application.Dto.CashOrder.ListCashOrderDto>


@{
    ViewBag.Title = "List of Cash Oders";
    Layout = "~/Views/Shared/_Layout _CashOrder.cshtml";
}

<style type="text/css">
	.k-link {
		min-width: 25px !important;
	}

	.k-window-action {
		visibility: hidden !important;
	}
</style>


<div class="well" style="width: 1030px !important">
    <div class="ui-widget-header">
        <h4 style="margin-left: 5px">Cash Orders</h4>
    </div>
    <div class="ui-widget-content" style="padding: 5px;">

        @if (ViewBag.IsValidUser == true)
        {
            <div class="row">
                <a style="margin-left: 20px; margin-bottom: 15px;" class="btn" href="@Url.Action("Create")"><strong> &nbsp; &nbsp; Add New Cash Order &nbsp; &nbsp;</strong></a>
            </div>

            @(Html.Kendo().Grid(Model)
                      .Name("Grid")
                      .Columns(columns =>
                      {
                          columns.Bound(e => e.ReferenceNumber).Width(20).Sortable(true);
                          //columns.Bound(e => e.MerchantName).Width(30).Sortable(true);
                          columns.Bound(e => e.SiteName).Width(40).Sortable(true);
                          columns.Bound(e => e.DeliveryDate).Width(20).Sortable(true);
                          columns.Bound(e => e.StatusName).Width(20).Sortable(true);
                          columns.Bound(e => e.OrderType).Width(30).Sortable(true);
                          columns.Bound(e => e.CashOrderAmount).Width(30).Sortable(false);

                          columns.Template(@<text></text>).ClientTemplate("<a title='View' href='" + Url.Action("View", "CashOrder") + "/?id=#=CashOrderId#'><img src='" + @Url.Content("~/Content/Images/grid_images/View.png") + "'/></a>").HtmlAttributes(new { @style = "text-align: center" });
                          columns.Template(@<text></text>)
                .ClientTemplate(
                    "<a title='Edit' href='" + Url.Action("Edit", "CashOrder") + "/?id=#=CashOrderId#'><img src='" + @Url.Content("~/Content/Images/grid_images/Edit.png") + "'/></a>"
                ).HtmlAttributes(new { @style = "text-align: center" });
                          columns.Template(@<text></text>).ClientTemplate("<a title='Submit' href='javascript:SubmitCashOrder(#=CashOrderId#, $(this))'><img src='" + @Url.Content("~/Content/Images/grid_images/submit.png") + "'/></a>").HtmlAttributes(new { @style = "text-align: center" });
                          columns.Template(@<text></text>).ClientTemplate("<a title='Copy' href='" + Url.Action("Copy", "CashOrder") + "/?id=#=CashOrderId#'><img src='" + @Url.Content("~/Content/Images/grid_images/Copy.png") + "'/></a>").HtmlAttributes(new { @style = "text-align: center" });
                          columns.Template(@<text></text>).ClientTemplate("<a title='Delete' href='javascript:DeleteCashOrder(#=CashOrderId#)'><img src='" + @Url.Content("~/Content/Images/grid_images/Delete.png") + "'/></a>").HtmlAttributes(new { @style = "text-align: center" });
                      })
                        .Filterable(filterable => filterable
                                .Extra(false)
                                .Operators(operators => operators
                                .ForString(str => str.Clear()
                                .StartsWith("Starts with")
                                .IsEqualTo("Is equal to")
                                .IsNotEqualTo("Is not equal to")
                                .Contains("Contains")
                            ))
                      )
                    .ToolBar(toolbar =>
                    {
                        toolbar.Template(@<text>

                            <table class="serach-toolbar">
                                <tr>
                                    <td>Search</td>
                                    <td>
                                        @(Html.Kendo().AutoComplete()
                                                .Name("SearchInput")
                                                .Filter("startswith")
                                                .MinLength(1)
                                                .HtmlAttributes(new { style = "width:350px" })
                                                .DataSource(source =>
                                                {
                                                    source.Read(read =>
                                                    {
                                                        read.Action("AutoCompleteCashOrdersByColumn", "CashOrder").Data("onAdditionalData");
                                                    })
                                                    .ServerFiltering(true);
                                                }))
                                    </td>

                                    <td><label class="category-label" for="category">Filter</label></td>
                                    <td>
                                        <div class="toolbar">
                                            @(Html.Kendo().DropDownList()
                                                    .Name("ddlFilterBy")
                                                    .OptionLabel("All")
                                                    .DataTextField("Name")
                                                    .DataValueField("Tag")
                                                    .AutoBind(false)
                                                    .HtmlAttributes(new { @style = "width:200px !important;" })
                                                    .DataSource(ds => ds.Read("CashOrdersColumnsListingToolbarTemplate", "CashOrder")))
                                        </div>
                                    </td>
                                    <td>
                                        <span id="gap" class="gap">
                                            <a class="btn" id="RebindGrid"><strong>Search</strong></a>
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </text>);
                    })
                                                            .TableHtmlAttributes(new { @style = "margin-bottom: 8px;" })
                                                            .Pageable(page => page.ButtonCount(5))
                                                            .Sortable(sort => sort.Enabled(true).AllowUnsort(false).SortMode(GridSortMode.MultipleColumn))
                                                            .DataSource(datasource => datasource
                                                            .Ajax()
                                                            .PageSize(5)
                                                            .ServerOperation(false)
                                                            .Model(a => a.Id(b => b.CashOrderId))))
        }
        else
        {
            <h4 style="color: red">
                The current logged in user has no profile. Make sure you are not making use of SBVAdmin Account when working on MySBV.
                This Account is only there for the development team. Thank you.
            </h4>
        }
    </div>
</div>

<script id="DeleteContainermWindow" type="text/x-kendo-template">
	<div style="margin-left:20px;">
		<img src="@Url.Content("~/Content/Images/question.png")" style="float:left" />
		<br />
		<p style="margin-left:5px;" class="confirmation-message">Are you sure you want to delete the Cash Order?</p>
	</div>

	<div style="margin-left:160px; margin-top:5px;">
		<button id="btnConfirmCancel" class="confirm-delete k-button" style="width:80px">Yes</button>
		<button id="btnNoCancel" class="no-cancel k-button" style="width:80px">No</button>
	</div>
</script>


<script id="ConfirmWindow" type="text/x-kendo-template">
	<div style="margin-left:20px;">
		<img src="@Url.Content("~/Content/Images/question.png")" style="float:left" />
		<br />
		<p style="margin-left:5px;" class="confirmation-message"></p>
	</div>

	<div style="margin-left:160px; margin-top:5px;">
		<button id="btnConfirmCancel" class="confirm-cancel k-button" style="width:80px">Yes</button>
		<button id="btnNoCancel" class="no-cancel k-button" style="width:80px">No</button>
	</div>
</script>


<script id="loadingWindow" type="text/x-kendo-template">
	<div style="margin-left:20px; margin-top:30px;">
		<table>
			<tr>
				<td><img src="@Url.Content("~/Content/Images/loading.gif")" /></td>
				<td style="width:10px;"></td>
				<td><span class="confirmation-message"></span></td>
			</tr>
		</table>
	</div>

	<div style="margin-left:160px; margin-top:5px;">
		<button id="btnConfirmCancel" class="confirm-cancel" style="width:80px; visibility:hidden">Yes</button>
	</div>
</script>


<form class="hide" method="POST" action="@Url.Action("Delete", "CashOrder")">
	<input type="submit" id="btnDeleteCashOrder" value="delete"/>
</form>

<script type="text/javascript">

	var isRetailUser = '@ViewBag.IsRetailUser';
	var isSBVTeller = '@ViewBag.IsSBVTeller';
	var isSBVAdmin = '@ViewBag.IsSBVAdmin';

	// Refresh grid
	$("#RebindGrid").click(function () {
		refreshGrid();
	});

	function refreshGrid() {
		var columnName = $("#ddlFilterBy").val();
		var searchValue = $.trim($("#SearchInput").val());

		searchValue = (searchValue == "") ? "________" : searchValue;

		var grid = $("#Grid").data("kendoGrid");

		if (columnName) {
			grid.dataSource.filter({ field: columnName, operator: "contains", value: searchValue });
		} else {
			grid.dataSource.filter({});
		}
	}



	// Change grid filter
	$("#ddlFilterBy").change(function () {

		$("#SearchInput").kendoAutoComplete({
			dataTextField: $(this).val()
		});

		$("#SearchInput").css("width", "350px");

		$("#SearchInput").val("");

		if ($(this).val() == "") {
			refreshGrid();
		}

		$("#SearchInput").val("");
	});

	function onAdditionalData() {
		return {
			columName: $("#ddlFilterBy").val(),
			searchData: $("#SearchInput").val()
		};
	}

	// Delete Cash Order
	function DeleteCashOrder(cashOrderId) {
		if (isRetailUser == "true" || isSBVTeller == "true" || isSBVAdmin == "true") {
			var url = '@Url.Action("Cancel","CashOrder")/?id=' + cashOrderId;
			ExecDelete(url);
		}
		else {
			$("#btnDeleteCashOrder").click();
		}
	}


	function ExecDelete(url) {

		var kendoWindow = $("<div />").kendoWindow({
			title: "Confirm Delete",
			resizable: false,
			modal: true,
			width: "430px",
			height: "160px"
		});

		kendoWindow.data("kendoWindow")
            .content($("#DeleteContainermWindow").html())
            .center().open();

		kendoWindow
            .find(".confirm-delete,.no-cancel")
            .click(function () {
            	if ($(this).hasClass("confirm-delete")) {
            		execute(url);
            	}
            	kendoWindow.data("kendoWindow").close();
            })
            .end();
	}




	function SubmitCashOrder(cashOrderId) {
		var kendoWindow = $("<div />").kendoWindow({
			title: "Cash Order",
			resizable: false,
			modal: true,
			width: 430,
			height: 160
		});

		kendoWindow.data("kendoWindow")
            .content($("#ConfirmWindow").html())
            .center().open();

		$(".confirmation-message").html("Are you sure you want to submit Cash Order?");

		kendoWindow
            .find(".no-cancel, .confirm-cancel")
            .click(function () {
            	if ($(this).hasClass("confirm-cancel")) {
            		loadingWindow("Please wait...<br/>Submitting Cash order.");
            		var url = '@Url.Action("Submit")/?id=' + cashOrderId;
            		window.location.href = url;
            	}

            	kendoWindow.data("kendoWindow").close();
            })
                .end();
	}




	function showLoadingBox(windowId, message) {

		var kendoWindow = $("<div />").kendoWindow({
			title: "Submit Cash Order",
			resizable: false,
			modal: true,
			width: 430,
			height: 160
		});

		kendoWindow.data("kendoWindow")
            .content($("#" + windowId).html())
            .center().open();
		$(".confirmation-message").html(message);

		kendoWindow
            .find(".no-cancel,.confirm-cancel")
            .click(function () {
            	kendoWindow.data("kendoWindow").close();
            })
            .end();
	}


	function loadingWindow(message) {
		var windowId = "loadingWindow";
		showLoadingBox(windowId, message);

		$("#loadingWindow").find(".k-window-action").css("visibility", "hidden");
	}




	// Utilitiy functions

	function execute(url) {
		$.post(url, function (data) {
			window.location.href = data.url;
		});

	}


</script>



